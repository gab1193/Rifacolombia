<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rifa Colombia 2026 üá®üá¥</title>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    html, body { background-color: #0f172a; margin: 0; overscroll-behavior: none; }
    body { font-family: 'Poppins', sans-serif; background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); min-height: 100vh; }

    .colombia-title {
      background: linear-gradient(to right, #fcd116 20%, #003893 40%, #ce1126 60%, #fcd116 80%);
      background-size: 200% auto;
      color: #fff;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine-colombia 4s linear infinite;
    }
    @keyframes shine-colombia { to { background-position: 200% center; } }

    .chrome-text {
      background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% auto;
      animation: shine 3s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    .number-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }

    .number-btn{
      aspect-ratio: 1; display:flex; align-items:center; justify-content:center;
      border-radius:12px; transition:all .2s cubic-bezier(.4,0,.2,1);
      font-weight:600; cursor:pointer; border:1px solid rgba(255,255,255,.1);
      background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(4px);
      user-select:none;
    }
    .available:hover { transform: translateY(-3px) scale(1.1); background: #3b82f6; color: white !important; border-color: #60a5fa; }
    .selected { background: #ffffff !important; color: #0f172a !important; box-shadow: 0 0 25px rgba(255, 255, 255, 0.5); transform: scale(1.1); border-color: white; }

    .sold {
      background: rgba(2, 6, 23, 0.7) !important;
      color: rgba(148,163,184,0.7) !important;
      border-color: rgba(148,163,184,0.15) !important;
      cursor:not-allowed !important;
      position: relative;
    }
    .sold::after{
      content:"VENDIDO";
      position:absolute;
      font-size:10px;
      font-weight:800;
      letter-spacing:.12em;
      opacity:.75;
      bottom:6px;
    }

    .reserved {
      background: rgba(30, 41, 59, 0.9) !important;
      color: rgba(251,191,36,0.9) !important;
      border-color: rgba(251,191,36,0.25) !important;
      cursor:not-allowed !important;
      position: relative;
    }
    .reserved::after{
      content:"RESERV";
      position:absolute;
      font-size:10px;
      font-weight:800;
      letter-spacing:.12em;
      opacity:.8;
      bottom:6px;
    }

    .glass-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }

    .progress-fill {
      background: linear-gradient(to right, #fbbf24 33%, #3b82f6 33%, #3b82f6 66%, #ef4444 66%);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      transition: width 2s cubic-bezier(0.65, 0, 0.35, 1);
    }
    .payment-icon { filter: grayscale(1) opacity(0.7); transition: 0.3s; }
    .payment-icon:hover { filter: grayscale(0) opacity(1); }
  </style>
</head>

<body class="text-slate-200 p-4">
  <div class="max-w-2xl mx-auto text-center mt-10">
    <h1 class="text-5xl font-extrabold mb-4 tracking-tight colombia-title">Rifa Colombia 2026</h1>

    <div class="mb-6">
      <p class="text-lg text-slate-400 uppercase tracking-widest font-semibold">Gran Premio de</p>
      <h2 class="chrome-text text-6xl md:text-7xl font-black my-2">$10,000 MXN</h2>
    </div>

    <div class="flex justify-center items-center gap-4 mb-10 bg-slate-800/30 py-3 px-6 rounded-full w-fit mx-auto border border-slate-700/50">
      <span class="text-[10px] uppercase font-bold text-slate-500 tracking-tighter">Pagos seguros v√≠a:</span>
      <img src="https://img.icons8.com/color/48/visa.png" class="h-5 payment-icon" alt="Visa"/>
      <img src="https://img.icons8.com/color/48/mastercard.png" class="h-5 payment-icon" alt="Mastercard"/>
      <img src="https://img.icons8.com/color/48/amex.png" class="h-5 payment-icon" alt="Amex"/>
      <span class="text-[10px] font-bold text-blue-400">Mercado Pago</span>
    </div>

    <div class="glass-card p-6 rounded-3xl mb-10 shadow-xl text-center">
      <p class="text-slate-300 leading-relaxed text-lg">
        ¬°Hola! Somos una <span class="text-yellow-500 font-bold">generaci√≥n de estudiantes de actuaci√≥n</span> de Hermosillo.
        Este 2026 viajaremos a representar el talento sonorense en <span class="text-blue-400 font-bold">Colombia</span>. üé≠ <br>
        <span class="text-white">Con tu apoyo, nos ayudas a llevar nuestro arte m√°s all√° de las fronteras.</span>
      </p>
    </div>

    <div class="glass-card p-6 rounded-3xl mb-8 shadow-xl border border-blue-500/20">
      <div class="flex justify-between items-end mb-3">
        <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Progreso de la Meta</span>
        <span class="text-xl font-black text-white">
          <span id="porcentaje-texto">0%</span>
          <span class="text-slate-500 font-medium text-sm ml-2">(<span id="boletos-vendidos-texto">...</span> / 500)</span>
        </span>
      </div>
      <div class="w-full bg-slate-950/50 rounded-full h-4 p-1 border border-slate-800">
        <div id="barra-progreso" class="progress-fill h-full rounded-full" style="width: 0%"></div>
      </div>
      <div class="mt-4 text-xs text-slate-400 flex flex-wrap justify-center gap-3">
        <span>‚úÖ Disponibles: <b id="disponibles-texto" class="text-white">...</b></span>
        <span>üü® Reservados: <b id="reservados-texto" class="text-yellow-400">...</b></span>
        <span>‚¨õ Vendidos: <b id="vendidos-texto" class="text-slate-200">...</b></span>
      </div>
    </div>

    <div class="glass-card p-8 rounded-[2rem] mb-8 shadow-2xl">
      <h2 class="text-2xl font-bold mb-1 text-white">1. Selecciona tu n√∫mero de la suerte</h2>
      <p class="text-green-400 font-medium mb-6">Solo $100 MXN por oportunidad</p>
      <div id="grid" class="number-grid max-h-[400px] overflow-y-auto p-4 rounded-2xl bg-slate-900/50"></div>
      <p id="status-msg" class="text-xs text-slate-400 mt-4"></p>
    </div>

    <div id="checkout-container" class="hidden glass-card p-8 rounded-[2rem] border-2 border-blue-500/50 mb-12 shadow-[0_0_40px_rgba(59,130,246,0.15)] transition-all duration-500">
      <h3 class="text-xl font-bold mb-6 text-white text-center">
        ‚ú® <span id="random-lucky-msg">...</span> Reservando el: <span id="selected-number-display" class="text-blue-400 text-3xl ml-2">--</span>
      </h3>

      <div class="space-y-4 mb-8 text-left">
        <div>
          <label class="block text-xs text-slate-400 mb-2 ml-1 font-bold uppercase tracking-widest">Nombre del Participante</label>
          <input type="text" id="user-name" placeholder="Tu nombre completo" class="w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 text-white focus:border-blue-500 outline-none transition-all">
        </div>
        <div>
          <label class="block text-xs text-slate-400 mb-2 ml-1 font-bold uppercase tracking-widest">WhatsApp (Solo n√∫meros)</label>
          <input type="tel" id="user-phone" placeholder="6621234567" class="w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 text-white focus:border-blue-500 outline-none transition-all">
        </div>
      </div>

      <button id="btn-pre-pago" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition-all shadow-xl shadow-blue-900/30 uppercase tracking-wider">
        Confirmar y Pagar
      </button>

      <div id="wallet_container" class="mt-4"></div>

      <p class="text-[11px] text-slate-500 mt-6 px-4 italic leading-relaxed text-center">
        üõ°Ô∏è Tus datos est√°n seguros. Se usar√°n exclusivamente para contactarte en caso de que tu n√∫mero resulte premiado.
      </p>
    </div>

    <div class="mt-8 pb-24">
      <p class="text-slate-500 font-medium mb-6 uppercase tracking-widest text-xs text-center">¬øDudas?</p>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="https://wa.me/6311824470" class="bg-green-600/10 text-green-400 border border-green-600/20 px-8 py-3 rounded-2xl font-bold hover:bg-green-600 hover:text-white transition-all">WhatsApp</a>
        <a href="https://instagram.com/TU_USUARIO" class="bg-pink-600/10 text-pink-400 border border-pink-600/20 px-8 py-3 rounded-2xl font-bold hover:bg-pink-600 hover:text-white transition-all">Instagram</a>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    // YA NO usamos el script directo (CORS), usamos el proxy de Vercel:
    const API_URL = "/api/gs";
    const mp = new MercadoPago("APP_USR-5cf8db98-d91a-44c4-bb21-b2206fd823a4", { locale: "es-MX" });

    // ========= STATE =========
    const grid = document.getElementById("grid");
    let currentNumber = null;

    const luckyMessages = [
      "¬°Excelente elecci√≥n!",
      "¬°Buena vibra!",
      "¬°El ganador!",
      "¬°A por todas!",
      "¬°Tu n√∫mero de la suerte!",
      "¬°Siento la suerte!",
      "¬°Hermosillo presente!"
    ];

    const btnByNumber = new Map();

    function buildGrid() {
      grid.innerHTML = "";
      btnByNumber.clear();

      for (let i = 1; i <= 500; i++) {
        const btn = document.createElement("div");
        btn.innerText = i;
        btn.className = "number-btn available";

        if (i % 3 === 0) btn.style.color = "#fbbf24";
        else if (i % 3 === 1) btn.style.color = "#60a5fa";
        else btn.style.color = "#f87171";

        btn.onclick = () => selectNumber(i, btn);

        grid.appendChild(btn);
        btnByNumber.set(i, btn);
      }
    }

    async function cargarStatus() {
      const msg = document.getElementById("status-msg");
      msg.textContent = "Cargando n√∫meros disponibles...";

      try {
        const response = await fetch(API_URL + "?action=get_status", { method: "GET" });
        const data = await response.json();

        const vendidos = data.vendidos_count || 0;
        const porcentaje = Math.floor((vendidos / 500) * 100);
        document.getElementById("barra-progreso").style.width = porcentaje + "%";
        document.getElementById("boletos-vendidos-texto").innerText = vendidos;
        document.getElementById("porcentaje-texto").innerText = porcentaje + "%";

        document.getElementById("disponibles-texto").innerText = data.disponibles_count ?? "...";
        document.getElementById("reservados-texto").innerText = data.reservados_count ?? "...";
        document.getElementById("vendidos-texto").innerText = data.vendidos_count ?? "...";

        for (const [num, btn] of btnByNumber.entries()) {
          btn.classList.remove("sold", "reserved", "selected");
          btn.classList.add("available");
          btn.style.pointerEvents = "auto";
          btn.onclick = () => selectNumber(num, btn);
        }

        (data.vendidos || []).forEach(n => {
          const btn = btnByNumber.get(Number(n));
          if (!btn) return;
          btn.classList.remove("available", "selected", "reserved");
          btn.classList.add("sold");
          btn.style.pointerEvents = "none";
          btn.onclick = null;
        });

        (data.reservados || []).forEach(n => {
          const btn = btnByNumber.get(Number(n));
          if (!btn) return;
          btn.classList.remove("available", "selected", "sold");
          btn.classList.add("reserved");
          btn.style.pointerEvents = "none";
          btn.onclick = null;
        });

        msg.textContent = "Listo ‚úÖ Elige un n√∫mero disponible.";
      } catch (e) {
        msg.textContent = "No pude cargar el estado. Revisa /api/gs.";
      }
    }

    function selectNumber(num, el) {
      if (el.classList.contains("sold") || el.classList.contains("reserved")) return;

      document.querySelectorAll(".number-btn").forEach(b => b.classList.remove("selected"));
      el.classList.add("selected");

      currentNumber = num;

      document.getElementById("wallet_container").innerHTML = "";
      const btnPre = document.getElementById("btn-pre-pago");
      btnPre.style.display = "block";
      btnPre.disabled = false;
      btnPre.innerText = "Confirmar y Pagar";

      document.getElementById("selected-number-display").innerText = num;
      document.getElementById("random-lucky-msg").innerText = luckyMessages[Math.floor(Math.random() * luckyMessages.length)];

      document.getElementById("checkout-container").classList.remove("hidden");
      document.getElementById("checkout-container").scrollIntoView({ behavior: "smooth", block: "center" });
    }

    async function renderPaymentButton() {
      const name = document.getElementById("user-name").value.trim();
      const phone = document.getElementById("user-phone").value.trim();
      const btnPre = document.getElementById("btn-pre-pago");

      if (!currentNumber) {
        alert("Selecciona un n√∫mero primero.");
        return;
      }

      if (!name || phone.length < 10 || isNaN(phone)) {
        alert("‚ö†Ô∏è WhatsApp v√°lido (solo n√∫meros, 10 d√≠gitos).");
        return;
      }

      btnPre.innerText = "Conectando...";
      btnPre.disabled = true;

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "create_preference",
            number: currentNumber,
            name: name,
            phone: phone
          })
        });

        const preference = await response.json();

        if (preference.ok && preference.id) {
          btnPre.style.display = "none";

          const bricksBuilder = mp.bricks();
          await bricksBuilder.create("wallet", "wallet_container", {
            initialization: { preferenceId: preference.id, redirectMode: "modal" }
          });

          await cargarStatus();
        } else {
          throw new Error(preference.error || "Sin preference id");
        }
      } catch (error) {
        alert("Error: " + error.message);
        btnPre.innerText = "Confirmar y Pagar";
        btnPre.disabled = false;
        await cargarStatus();
      }
    }

    document.getElementById("btn-pre-pago").addEventListener("click", renderPaymentButton);

    buildGrid();
    cargarStatus();
  </script>
</body>
</html>
