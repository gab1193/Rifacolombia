<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/favicon.png">
  <meta name="theme-color" content="#0f172a">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Colombia 2026 ‚Äî Acceso Camerino VIP üá®üá¥</title>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    html, body { background-color: #0f172a; margin: 0; overscroll-behavior: none; }
    body { font-family: 'Poppins', sans-serif; background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); min-height: 100vh; }

    .colombia-title {
      background: linear-gradient(to right, #fcd116 20%, #003893 40%, #ce1126 60%, #fcd116 80%);
      background-size: 200% auto;
      color: #fff;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine-colombia 4s linear infinite;
    }
    @keyframes shine-colombia { to { background-position: 200% center; } }

    .chrome-text {
      background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% auto;
      animation: shine 3s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    .number-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }

    .number-btn{
      aspect-ratio: 1; display:flex; align-items:center; justify-content:center;
      border-radius:12px; transition:all .2s cubic-bezier(.4,0,.2,1);
      font-weight:600; cursor:pointer; border:1px solid rgba(255,255,255,.1);
      background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(4px);
      user-select:none;
      position: relative;
    }
    .available:hover { transform: translateY(-3px) scale(1.1); background: #3b82f6; color: white !important; border-color: #60a5fa; }
    .selected { background: #ffffff !important; color: #0f172a !important; box-shadow: 0 0 25px rgba(255, 255, 255, 0.5); transform: scale(1.08); border-color: white; }

    .sold {
      background: rgba(2, 6, 23, 0.7) !important;
      color: rgba(148,163,184,0.7) !important;
      border-color: rgba(148,163,184,0.15) !important;
      cursor:not-allowed !important;
    }
    .sold::after{
      content:"VENDIDO";
      position:absolute;
      font-size:10px;
      font-weight:800;
      letter-spacing:.12em;
      opacity:.75;
      bottom:6px;
    }

    .reserved {
      background: rgba(30, 41, 59, 0.9) !important;
      color: rgba(251,191,36,0.9) !important;
      border-color: rgba(251,191,36,0.25) !important;
      cursor:not-allowed !important;
    }
    .reserved::after{
      content:"RESERV";
      position:absolute;
      font-size:10px;
      font-weight:800;
      letter-spacing:.12em;
      opacity:.8;
      bottom:6px;
    }

    .glass-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }

    .progress-fill {
      background: linear-gradient(to right, #fbbf24 33%, #3b82f6 33%, #3b82f6 66%, #ef4444 66%);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      transition: width 1.2s cubic-bezier(0.65, 0, 0.35, 1);
    }
    .payment-icon { filter: grayscale(1) opacity(0.7); transition: 0.3s; }
    .payment-icon:hover { filter: grayscale(0) opacity(1); }

    .pay-pill {
      border: 1px solid rgba(148,163,184,.2);
      background: rgba(2,6,23,.35);
      padding: 12px 14px;
      border-radius: 16px;
      cursor: pointer;
      user-select: none;
      transition: .2s;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .pay-pill:hover { transform: translateY(-1px); border-color: rgba(59,130,246,.45); }
    .pay-pill.active {
      border-color: rgba(59,130,246,.7);
      background: rgba(59,130,246,.15);
      box-shadow: 0 0 0 2px rgba(59,130,246,.15) inset;
    }

    /* ===== Overlay Confirmaci√≥n ===== */
    body.modal-open { overflow: hidden; height: 100vh; }

    .overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(2,6,23,.75);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;

      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .overlay.show { display: flex; }

    .ticket-card{
      background: rgba(30,41,59,.65);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 28px;
      box-shadow: 0 10px 40px rgba(0,0,0,.4);
      width: 100%;
      max-width: 520px;

      max-height: calc(100vh - 36px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .ticket-head{
      padding: 18px 18px 14px 18px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(135deg, rgba(59,130,246,.18), rgba(251,191,36,.12), rgba(239,68,68,.10));
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(2,6,23,.35);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .ticket-body{ padding: 18px; }
    .kv { display:flex; justify-content:space-between; gap:12px; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,.08); }
    .kv:last-child{ border-bottom: none; }
    .kv .k{ color: rgba(148,163,184,1); font-size: 12px; text-transform: uppercase; letter-spacing:.16em; font-weight: 800; }
    .kv .v{ color: white; font-weight: 700; }
    .big-number{
      font-size: 60px;
      font-weight: 900;
      letter-spacing: -0.04em;
      line-height: 1;
      color: white;
      text-shadow: 0 0 20px rgba(59,130,246,.2);
    }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.25);
      color: rgba(226,232,240,1);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .06em;
    }
    .btnx{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.12em;
      transition:.2s;
      width: 100%;
    }
    .btn-primary{ background:#3b82f6; color:white; }
    .btn-primary:hover{ filter: brightness(1.08); transform: translateY(-1px); }
    .btn-ghost{
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.25);
      color: rgba(226,232,240,1);
    }
    .btn-ghost:hover{ border-color: rgba(59,130,246,.5); transform: translateY(-1px); }
    .spinner{
      width: 18px; height: 18px; border-radius: 50%;
      border: 3px solid rgba(255,255,255,.2);
      border-top-color: white;
      animation: spin 1s linear infinite;
      display:inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* impresi√≥n del ticket */
    @media print {
      body { background: white !important; overflow: visible !important; height:auto !important; }
      .overlay { position: static; display: block !important; background: transparent; backdrop-filter:none; overflow: visible !important; }
      #overlayClose { display:none !important; }
      #ticketActions { display:none !important; }
      .ticket-card { box-shadow:none; border:1px solid #ddd; background: white; max-height:none !important; overflow: visible !important; }
      .ticket-body, .ticket-head { color: #111827 !important; background: white !important; }
      .kv .k { color: #374151 !important; }
      .kv .v { color: #111827 !important; }
      .big-number { color: #111827 !important; text-shadow:none; }
      .chip { border:1px solid #ddd; background:#f9fafb; color:#111827; }
    }

    /* ===== Ventana 72h (bono/beneficio) ===== */
    #promoBar{
      background: linear-gradient(to right, rgba(251,191,36,.95), rgba(59,130,246,.85), rgba(239,68,68,.85));
      box-shadow: 0 0 18px rgba(251,191,36,0.18);
      transition: width .9s cubic-bezier(.4,0,.2,1);
    }

    /* ===== Mini gu√≠a (reduce frustraci√≥n) ===== */
    .helper-bar{
      position: sticky;
      top: 10px;
      z-index: 50;
      margin: 0 0 12px 0;
      border-radius: 18px;
      border: 1px solid rgba(59,130,246,.25);
      background: rgba(2,6,23,.35);
      backdrop-filter: blur(10px);
      padding: 12px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .helper-left{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .helper-step{
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(226,232,240,1);
      opacity: .92;
    }
    .helper-sub{
      font-size: 11px;
      color: rgba(148,163,184,1);
      font-weight: 700;
    }

    /* ===== BOT√ìN CAMERINO (VIP) ===== */
    .vip-fab{
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 9998; /* debajo del overlay (9999) */
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      user-select: none;
    }
    .vip-btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.45);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      transition: transform .2s, border-color .2s, filter .2s;
      text-decoration: none;
    }
    .vip-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(251,191,36,.45);
      filter: brightness(1.06);
    }
    .vip-title{
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 12px;
      color: #fff;
      white-space: nowrap;
    }
    .vip-pill{
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .18em;
      text-transform: uppercase;
      padding: 6px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(251,191,36,.95), rgba(59,130,246,.85), rgba(239,68,68,.85));
      color: rgba(2,6,23,1);
      box-shadow: 0 0 18px rgba(251,191,36,.15);
      white-space: nowrap;
    }
    .vip-sub{
      font-size: 11px;
      font-weight: 700;
      color: rgba(226,232,240,.75);
      line-height: 1.1;
      max-width: 210px;
      text-align: right;
    }
  </style>
</head>

<body class="text-slate-200 p-4">

  <!-- ===== BOT√ìN VIP CAMERINO (TOP RIGHT) ===== -->
  <div class="vip-fab" aria-label="Acceso VIP">
    <a class="vip-btn" href="camerino.html" title="Entrar al Camerino">
      <span class="vip-pill">VIP</span>
      <span class="vip-title">Camerino</span>
      <span aria-hidden="true" style="font-size:14px; opacity:.9;">üé≠</span>
    </a>
    <div class="vip-sub">Contenido premium para compradores. Entra con tu <b>folio</b> ‚úÖ</div>
  </div>

  <div class="max-w-2xl mx-auto text-center mt-10">
    <h1 class="text-5xl font-extrabold mb-4 tracking-tight colombia-title">Colombia 2026</h1>
    <div class="text-sm text-slate-300 font-bold tracking-wider uppercase mb-6">Acceso Camerino VIP ‚Ä¢ Apoyo a estudiantes</div>

    <!-- ===== Ventana 72H (BONO) ===== -->
    <div id="promo72h" class="glass-card p-5 md:p-6 rounded-[2rem] mb-8 border border-yellow-400/25 shadow-2xl text-left">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-xs font-black tracking-[.2em] uppercase text-yellow-300/90">Ventana especial de 72 horas</div>
          <div class="text-white font-black text-xl md:text-2xl mt-1">Bono extra: $500 MXN en tarjeta de regalo Amazon üéÅ</div>
          <p class="text-slate-300 text-sm md:text-base mt-2 leading-relaxed">
            Los accesos confirmados dentro de estas <b class="text-white">72 horas</b> entran autom√°ticamente.
            Al terminar el contador se cierra la ventana y se publica el resultado.
          </p>
        </div>

        <div class="text-right">
          <div class="text-[10px] uppercase tracking-[.2em] font-black text-slate-400">Termina en</div>
          <div id="promoTime" class="text-white font-black text-3xl md:text-4xl mt-1">--:--:--</div>
          <div id="promoState" class="text-xs font-black text-blue-400 mt-2">ACTIVO</div>
        </div>
      </div>

      <div class="mt-4">
        <div class="w-full bg-slate-950/50 rounded-full h-3 p-1 border border-slate-800">
          <div id="promoBar" class="h-full rounded-full" style="width: 100%"></div>
        </div>
        <div id="promoEndsAt" class="text-[11px] text-slate-400 mt-2"></div>
      </div>
    </div>

    <div class="mb-6">
      <p class="text-lg text-slate-400 uppercase tracking-widest font-semibold">Premio en efectivo</p>
      <h2 class="chrome-text text-6xl md:text-7xl font-black my-2">$10,000 MXN</h2>
      <div class="text-[12px] text-slate-400 font-bold mt-1">Se anunciar√° p√∫blicamente al finalizar la din√°mica.</div>
    </div>

    <div class="flex justify-center items-center gap-4 mb-10 bg-slate-800/30 py-3 px-6 rounded-full w-fit mx-auto border border-slate-700/50">
      <span class="text-[10px] uppercase font-bold text-slate-500 tracking-tighter">Pagos seguros v√≠a:</span>
      <img src="https://img.icons8.com/color/48/visa.png" class="h-5 payment-icon" alt="Visa"/>
      <img src="https://img.icons8.com/color/48/mastercard.png" class="h-5 payment-icon" alt="Mastercard"/>
      <img src="https://img.icons8.com/color/48/amex.png" class="h-5 payment-icon" alt="Amex"/>
      <span class="text-[10px] font-bold text-blue-400">Mercado Pago</span>
    </div>

    <div class="glass-card p-6 rounded-3xl mb-10 shadow-xl text-center">
      <p class="text-slate-300 leading-relaxed text-lg">
        ¬°Hola! Somos una <span class="text-yellow-500 font-bold">generaci√≥n de estudiantes de actuaci√≥n</span> de Hermosillo.
        En 2026 viajaremos a representar el talento sonorense en <span class="text-blue-400 font-bold">Colombia</span>. üé≠ <br>
        <span class="text-white">Tu apoyo desbloquea el Camerino VIP</span> con contenido exclusivo (canciones, backstage y agradecimientos).
      </p>
    </div>

    <div class="glass-card p-6 rounded-3xl mb-8 shadow-xl border border-blue-500/20">
      <div class="flex justify-between items-end mb-3">
        <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Progreso de la Meta</span>
        <span class="text-xl font-black text-white">
          <span id="porcentaje-texto">0%</span>
          <span class="text-slate-500 font-medium text-sm ml-2">(<span id="boletos-vendidos-texto">...</span> / 500)</span>
        </span>
      </div>
      <div class="w-full bg-slate-950/50 rounded-full h-4 p-1 border border-slate-800">
        <div id="barra-progreso" class="progress-fill h-full rounded-full" style="width: 0%"></div>
      </div>
      <div class="mt-4 text-xs text-slate-400 flex flex-wrap justify-center gap-3">
        <span>‚úÖ Disponibles: <b id="disponibles-texto" class="text-white">...</b></span>
        <span>üü® Reservados: <b id="reservados-texto" class="text-yellow-400">...</b></span>
        <span>‚¨õ Confirmados: <b id="vendidos-texto" class="text-slate-200">...</b></span>
      </div>
    </div>

    <div class="glass-card p-8 rounded-[2rem] mb-8 shadow-2xl">
      <div class="flex items-start justify-between gap-4 mb-3">
        <div class="text-left">
          <h2 class="text-2xl font-bold mb-1 text-white">1. Elige tu(s) folio(s)</h2>
          <p class="text-green-400 font-medium">Aporte: $100 MXN por acceso</p>
        </div>
        <div class="text-right">
          <div class="text-[10px] uppercase tracking-[.2em] font-black text-slate-400">Seleccionados</div>
          <div class="text-white font-black text-2xl"><span id="selCount">0</span></div>
          <div class="text-slate-400 text-xs font-bold">Total: <span class="text-white">$</span><span id="selTotal" class="text-white">0</span></div>
        </div>
      </div>

      <!-- ‚úÖ Mini gu√≠a anti-frustraci√≥n -->
      <div class="helper-bar text-left">
        <div class="helper-left">
          <span class="helper-step">1) Elige</span>
          <span class="helper-sub">Toca para seleccionar / tocar otra vez para quitar.</span>
          <span class="helper-sub">Puedes elegir varios en una sola compra.</span>
          <span class="chip">M√°x: <span id="maxSelTxt">10</span></span>
        </div>
        <button id="btnClearSel" class="btnx btn-ghost" style="width:auto; padding:10px 12px;">Limpiar</button>
      </div>

      <div id="grid" class="number-grid max-h-[400px] overflow-y-auto p-4 rounded-2xl bg-slate-900/50"></div>
      <p id="status-msg" class="text-xs text-slate-400 mt-4"></p>
    </div>

    <div id="checkout-container" class="hidden glass-card p-8 rounded-[2rem] border-2 border-blue-500/50 mb-12 shadow-[0_0_40px_rgba(59,130,246,0.15)] transition-all duration-500">
      <h3 class="text-xl font-bold mb-4 text-white text-center">
        ‚ú® <span id="random-lucky-msg">...</span>
      </h3>

      <!-- ‚úÖ Resumen de selecci√≥n (multi) -->
      <div class="glass-card p-4 rounded-2xl mb-6 border border-slate-700/40 bg-slate-900/30 text-left">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-xs font-black tracking-[.2em] uppercase text-slate-400">Tu selecci√≥n</div>
            <div class="text-white font-black text-lg mt-1">
              <span id="selected-count-display">0</span> acceso(s) ‚Ä¢ Total: <span class="text-blue-400">$</span><span id="selected-total-display" class="text-blue-400">0</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-[10px] uppercase tracking-[.2em] font-black text-slate-400">Folios</div>
            <div id="selected-number-display" class="text-blue-400 text-lg font-black leading-tight">‚Äî</div>
          </div>
        </div>
        <p class="text-[11px] text-slate-400 mt-3 leading-relaxed">
          Tip: Si eliges <b class="text-white">transferencia/OXXO</b>, tu selecci√≥n se reserva 24h para que completes el pago.
        </p>
      </div>

      <div class="space-y-4 mb-8 text-left">
        <div>
          <label class="block text-xs text-slate-400 mb-2 ml-1 font-bold uppercase tracking-widest">Nombre</label>
          <input type="text" id="user-name" placeholder="Tu nombre completo" class="w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 text-white focus:border-blue-500 outline-none transition-all">
        </div>
        <div>
          <label class="block text-xs text-slate-400 mb-2 ml-1 font-bold uppercase tracking-widest">WhatsApp (Solo n√∫meros)</label>
          <input type="tel" id="user-phone" placeholder="6621234567" class="w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 text-white focus:border-blue-500 outline-none transition-all">
        </div>
      </div>

      <!-- selector m√©todo -->
      <div class="text-left mb-6">
        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2 ml-1">M√©todo de pago</p>

        <div class="grid grid-cols-1 gap-3">
          <div id="pill-instant" class="pay-pill active" role="button" tabindex="0">
            <div>
              <div class="text-white font-bold">Pago inmediato</div>
              <div class="text-xs text-slate-400">Tarjeta / saldo Mercado Pago (confirmaci√≥n al instante)</div>
            </div>
            <div class="text-xs font-black text-blue-400">RESERVA 10 MIN</div>
          </div>

          <div id="pill-offline" class="pay-pill" role="button" tabindex="0">
            <div>
              <div class="text-white font-bold">Transferencia / OXXO</div>
              <div class="text-xs text-slate-400">Puede tardar en confirmarse (Mercado Pago lo valida)</div>
            </div>
            <div class="text-xs font-black text-yellow-400">RESERVA 24 H</div>
          </div>
        </div>

        <p id="reserve-note" class="text-[11px] text-slate-400 mt-3">
          ‚è≥ Tu selecci√≥n queda reservada <b class="text-white">10 minutos</b> mientras realizas el pago inmediato.
        </p>
      </div>

      <button id="btn-pre-pago" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition-all shadow-xl shadow-blue-900/30 uppercase tracking-wider">
        Confirmar y Pagar
      </button>

      <div id="wallet_container" class="mt-4"></div>

      <p class="text-[11px] text-slate-500 mt-6 px-4 italic leading-relaxed text-center">
        üõ°Ô∏è Tus datos est√°n seguros. Se usar√°n para identificar tu acceso y, si aplica, contactarte por el premio.
      </p>
    </div>

    <!-- ===== FAQ + REGLAS ===== -->
    <div class="glass-card p-8 rounded-[2rem] mb-10 shadow-2xl text-left">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h2 class="text-2xl font-black text-white">Preguntas frecuentes</h2>
        <span class="text-xs font-black tracking-[.2em] uppercase text-slate-400">FAQ</span>
      </div>

      <div id="faqList" class="space-y-3">
        <div class="faq-item border border-slate-700/40 rounded-2xl bg-slate-900/30 overflow-hidden">
          <button class="faq-btn w-full text-left px-5 py-4 flex items-center justify-between gap-3">
            <span class="font-bold text-white">¬øCu√°nto cuesta el acceso?</span>
            <span class="faq-ico text-slate-300 font-black">+</span>
          </button>
          <div class="faq-body hidden px-5 pb-5 text-slate-300">
            El acceso cuesta <b class="text-white">$100 MXN</b>.
          </div>
        </div>

        <div class="faq-item border border-slate-700/40 rounded-2xl bg-slate-900/30 overflow-hidden">
          <button class="faq-btn w-full text-left px-5 py-4 flex items-center justify-between gap-3">
            <span class="font-bold text-white">¬øQu√© m√©todos de pago aceptan?</span>
            <span class="faq-ico text-slate-300 font-black">+</span>
          </button>
          <div class="faq-body hidden px-5 pb-5 text-slate-300">
            <b class="text-white">Tarjeta / saldo Mercado Pago</b> (confirmaci√≥n al instante) y <b class="text-white">Transferencia / OXXO</b> (puede tardar en confirmarse).
          </div>
        </div>

        <div class="faq-item border border-slate-700/40 rounded-2xl bg-slate-900/30 overflow-hidden">
          <button class="faq-btn w-full text-left px-5 py-4 flex items-center justify-between gap-3">
            <span class="font-bold text-white">¬øQu√© pasa si pago por transferencia u OXXO?</span>
            <span class="faq-ico text-slate-300 font-black">+</span>
          </button>
          <div class="faq-body hidden px-5 pb-5 text-slate-300">
            Tu selecci√≥n queda <b class="text-white">reservada 24 horas</b>. Cuando Mercado Pago confirme el pago, el estado cambia autom√°ticamente a <b class="text-white">VENDIDO</b>.
          </div>
        </div>

        <div class="faq-item border border-slate-700/40 rounded-2xl bg-slate-900/30 overflow-hidden">
          <button class="faq-btn w-full text-left px-5 py-4 flex items-center justify-between gap-3">
            <span class="font-bold text-white">¬øQu√© pasa si no pago a tiempo?</span>
            <span class="faq-ico text-slate-300 font-black">+</span>
          </button>
          <div class="faq-body hidden px-5 pb-5 text-slate-300">
            Si el pago no se completa dentro del tiempo de reserva, los folios vuelven a estar disponibles.
          </div>
        </div>

        <div class="faq-item border border-slate-700/40 rounded-2xl bg-slate-900/30 overflow-hidden">
          <button class="faq-btn w-full text-left px-5 py-4 flex items-center justify-between gap-3">
            <span class="font-bold text-white">¬øC√≥mo recibo mi comprobante?</span>
            <span class="faq-ico text-slate-300 font-black">+</span>
          </button>
          <div class="faq-body hidden px-5 pb-5 text-slate-300">
            Al finalizar el pago se muestra tu <b class="text-white">comprobante digital</b> con tus folios, nombre, WhatsApp y folio de pago. Puedes <b class="text-white">guardarlo/imprimirlo</b>.
          </div>
        </div>

        <div class="faq-item border border-slate-700/40 rounded-2xl bg-slate-900/30 overflow-hidden">
          <button class="faq-btn w-full text-left px-5 py-4 flex items-center justify-between gap-3">
            <span class="font-bold text-white">¬øPuedo elegir m√°s de un folio?</span>
            <span class="faq-ico text-slate-300 font-black">+</span>
          </button>
          <div class="faq-body hidden px-5 pb-5 text-slate-300">
            S√≠. Puedes <b class="text-white">seleccionar varios folios</b> y pagarlos <b class="text-white">en una sola compra</b>.
          </div>
        </div>

        <div class="mt-8 pt-6 border-t border-slate-700/40">
          <h3 class="text-lg font-black text-white mb-2">Reglas r√°pidas</h3>
          <ul class="text-slate-300 text-sm leading-relaxed space-y-2">
            <li>‚Ä¢ La compra se confirma cuando el pago aparece como <b class="text-white">APROBADO</b> en Mercado Pago.</li>
            <li>‚Ä¢ Para <b class="text-white">transferencia/OXXO</b>, la confirmaci√≥n puede tardar; tu selecci√≥n queda reservada hasta 24h.</li>
            <li>‚Ä¢ Si el pago no se confirma dentro del periodo de reserva, los folios vuelven a estar disponibles.</li>
            <li>‚Ä¢ Guarda tu <b class="text-white">comprobante</b> (captura/impresi√≥n) como referencia.</li>
            <li>‚Ä¢ La fecha del anuncio del premio se publicar√° cuando se alcance el 40% de confirmaciones.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="mt-8 pb-24">
      <p class="text-slate-500 font-medium mb-6 uppercase tracking-widest text-xs text-center">¬øDudas?</p>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="https://wa.me/6311824470" class="bg-green-600/10 text-green-400 border border-green-600/20 px-8 py-3 rounded-2xl font-bold hover:bg-green-600 hover:text-white transition-all">WhatsApp</a>
        <a href="https://www.instagram.com/gabrielllllllllllllll/" class="bg-pink-600/10 text-pink-400 border border-pink-600/20 px-8 py-3 rounded-2xl font-bold hover:bg-pink-600 hover:text-white transition-all">Instagram</a>
      </div>
    </div>
  </div>

  <!-- ===== Overlay Confirmaci√≥n + Comprobante ===== -->
  <div id="confirmOverlay" class="overlay" aria-hidden="true">
    <div class="ticket-card">
      <div class="ticket-head">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-white font-black text-xl">Tu compra</div>
            <div id="ovSubtitle" class="text-slate-200/80 text-sm">Verificando el pago‚Ä¶</div>
          </div>
          <button id="overlayClose" class="btnx btn-ghost" style="width:auto; padding:10px 12px;">Cerrar</button>
        </div>
        <div class="mt-4 flex items-center justify-between gap-3">
          <span id="ovBadge" class="badge"><span class="spinner"></span> PROCESANDO</span>
          <div class="text-right">
            <div class="text-slate-200/70 text-xs uppercase tracking-[.2em] font-black">Folios / Accesos</div>
            <div id="ovNumber" class="big-number">--</div>
          </div>
        </div>

        <!-- ‚úÖ lista corta de folios en header -->
        <div id="ovNumbersRow" class="mt-3 text-left hidden">
          <div class="text-[10px] uppercase tracking-[.2em] font-black text-slate-200/70">Folios</div>
          <div id="ovNumbers" class="text-white font-black text-sm mt-1 leading-relaxed">‚Äî</div>
        </div>
      </div>

      <div class="ticket-body">
        <div id="ticketKVs" class="space-y-0">
          <div class="kv"><div class="k">Nombre</div><div id="tName" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">WhatsApp</div><div id="tPhone" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">Estado</div><div id="tStatus" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">Pago ID</div><div id="tPayId" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">Fecha</div><div id="tDate" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">Total</div><div id="tTotal" class="v">‚Äî</div></div>
        </div>

        <!-- LINK PERMANENTE + QR -->
        <div id="ticketShare" class="mt-6 p-4 rounded-2xl border border-slate-700/40 bg-slate-900/30">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-xs font-black tracking-[.2em] uppercase text-slate-400">Tu comprobante permanente</div>
              <div class="text-slate-200 text-sm">Gu√°rdalo o comp√°rtelo (incluye QR).</div>
            </div>
            <div class="text-xs font-black text-blue-400" id="shareStatus">‚Äî</div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
            <div>
              <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2">Link</div>
              <div class="flex gap-2">
                <input id="ticketLinkInput" class="w-full bg-slate-950/40 border border-slate-700 rounded-2xl px-4 py-3 text-white text-sm outline-none"
                       readonly value="‚Äî"/>
                <button id="btnCopyLink" class="btnx btn-ghost" style="width:auto; padding:10px 12px;">Copiar</button>
              </div>
              <p class="text-[11px] text-slate-400 mt-2 leading-relaxed">
                Tip: si cierras la p√°gina, con este link puedes volver a ver tu comprobante.
              </p>
            </div>

            <div>
              <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2">QR</div>
              <div class="flex items-center justify-center bg-slate-950/30 border border-slate-700 rounded-2xl p-4">
                <div id="ticketQR"></div>
              </div>
              <p class="text-[11px] text-slate-400 mt-2 leading-relaxed">
                Escan√©alo para abrir tu comprobante.
              </p>
            </div>
          </div>
        </div>

        <div id="ticketActions" class="mt-6 space-y-3">
          <button id="btnPrint" class="btnx btn-primary">Guardar / Imprimir</button>
          <button id="btnRefreshStatus" class="btnx btn-ghost">Actualizar estado</button>
        </div>

        <p class="text-[11px] text-slate-400 mt-5 leading-relaxed">
          Tip: Si pagaste por <b class="text-white">transferencia/OXXO</b>, puede tardar. Tu selecci√≥n queda reservada y cuando Mercado Pago lo confirme, se pondr√° <b class="text-white">VENDIDO</b>.
        </p>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const API_URL = "/api/gs";

  // ‚úÖ Public Key (frontend)
  const MP_PUBLIC_KEY = "APP_USR-5cf8db98-d91a-44c4-bb21-b2206fd823a4";
  const mp = new MercadoPago(MP_PUBLIC_KEY, { locale: "es-MX" });

  // ========= STATE =========
  const grid = document.getElementById("grid");

  // ‚úÖ MULTI
  const PRICE = 100;
  const MAX_SELECT = 10;
  document.getElementById("maxSelTxt").textContent = String(MAX_SELECT);

  let selectedNumbers = []; // array de folios (enteros)

  // ‚úÖ FIX BUG: candado de checkout (para que no desaparezca el bot√≥n MP al reservar)
  let checkoutLocked = false;
  let lockedNumbers = [];

  // ‚úÖ bloquear selecci√≥n mientras carga status
  let isLoadingStatus = true;

  // modo UI
  let payMode = "instant"; // instant/offline

  const luckyMessages = [
    "¬°Excelente elecci√≥n!",
    "¬°Buena vibra!",
    "¬°A por todas!",
    "¬°Se siente la suerte!",
    "¬°Hermosillo presente!",
    "¬°Vamos con todo!",
    "¬°Qu√© buena selecci√≥n!"
  ];

  const btnByNumber = new Map();

  function setGridEnabled(enabled){
    grid.style.pointerEvents = enabled ? "auto" : "none";
    grid.style.opacity = enabled ? "1" : "0.65";
  }

  // ========= UI: selector m√©todo =========
  const pillInstant = document.getElementById("pill-instant");
  const pillOffline = document.getElementById("pill-offline");
  const reserveNote = document.getElementById("reserve-note");

  function resetCheckoutUI_() {
    document.getElementById("wallet_container").innerHTML = "";
    const btnPre = document.getElementById("btn-pre-pago");
    btnPre.style.display = "block";
    btnPre.disabled = false;
    btnPre.innerText = "Confirmar y Pagar";
  }

  function setPayMode(mode) {
    if (checkoutLocked) return; // ‚úÖ no permitir cambiar m√©todo cuando ya se cre√≥ el pago

    payMode = mode;
    resetCheckoutUI_();

    if (mode === "offline") {
      pillOffline.classList.add("active");
      pillInstant.classList.remove("active");
      reserveNote.innerHTML = `‚è≥ Tu selecci√≥n queda reservada <b class="text-white">24 horas</b> para que completes transferencia / OXXO.`;
    } else {
      pillInstant.classList.add("active");
      pillOffline.classList.remove("active");
      reserveNote.innerHTML = `‚è≥ Tu selecci√≥n queda reservada <b class="text-white">10 minutos</b> mientras realizas el pago inmediato.`;
    }
  }

  pillInstant.addEventListener("click", () => setPayMode("instant"));
  pillOffline.addEventListener("click", () => setPayMode("offline"));

  // ========= UI: selecci√≥n multi =========
  const selCountEl = document.getElementById("selCount");
  const selTotalEl = document.getElementById("selTotal");
  const selectedCountDisplay = document.getElementById("selected-count-display");
  const selectedTotalDisplay = document.getElementById("selected-total-display");
  const selectedNumberDisplay = document.getElementById("selected-number-display");
  const btnClearSel = document.getElementById("btnClearSel");

  function formatNumberList_(arr){
    const a = [...arr].sort((x,y)=>x-y);
    return a.join(", ");
  }

  // ‚úÖ FIX BUG: si ya se gener√≥ preference, mostramos lockedNumbers aunque el status los marque RESERVADO
  function updateSelectionUI_(){
    const displayNums = checkoutLocked ? lockedNumbers : selectedNumbers;

    const count = displayNums.length;
    const total = count * PRICE;

    selCountEl.textContent = String(count);
    selTotalEl.textContent = String(total);

    selectedCountDisplay.textContent = String(count);
    selectedTotalDisplay.textContent = String(total);

    selectedNumberDisplay.textContent = count ? formatNumberList_(displayNums) : "‚Äî";

    const checkout = document.getElementById("checkout-container");
    if (count > 0) {
      checkout.classList.remove("hidden");
    } else {
      checkout.classList.add("hidden");
    }
  }

  function clearSelection_(){
    if (checkoutLocked) {
      alert("‚ö†Ô∏è Ya generaste el pago. Si quieres cambiar selecci√≥n, recarga la p√°gina.");
      return;
    }

    for (const n of selectedNumbers) {
      const btn = btnByNumber.get(Number(n));
      if (btn) btn.classList.remove("selected");
    }
    selectedNumbers = [];
    resetCheckoutUI_();
    updateSelectionUI_();
  }

  btnClearSel.addEventListener("click", clearSelection_);

  // ========= UI: grid =========
  function buildGrid() {
    grid.innerHTML = "";
    btnByNumber.clear();

    for (let i = 1; i <= 500; i++) {
      const btn = document.createElement("div");
      btn.innerText = i;
      btn.className = "number-btn available";

      if (i % 3 === 0) btn.style.color = "#fbbf24";
      else if (i % 3 === 1) btn.style.color = "#60a5fa";
      else btn.style.color = "#f87171";

      btn.onclick = () => toggleNumber(i, btn);

      grid.appendChild(btn);
      btnByNumber.set(i, btn);
    }
  }

  async function cargarStatus() {
    const msg = document.getElementById("status-msg");
    msg.textContent = "Cargando folios disponibles...";

    isLoadingStatus = true;
    setGridEnabled(false);

    try {
      const response = await fetch(API_URL + "?action=get_status", { method: "GET" });
      const data = await response.json();

      const vendidos = data.vendidos_count || 0;
      const porcentaje = Math.floor((vendidos / 500) * 100);
      document.getElementById("barra-progreso").style.width = porcentaje + "%";
      document.getElementById("boletos-vendidos-texto").innerText = vendidos;
      document.getElementById("porcentaje-texto").innerText = porcentaje + "%";

      document.getElementById("disponibles-texto").innerText = data.disponibles_count ?? "...";
      document.getElementById("reservados-texto").innerText = data.reservados_count ?? "...";
      document.getElementById("vendidos-texto").innerText = data.vendidos_count ?? "...";

      // reset grid
      for (const [num, btn] of btnByNumber.entries()) {
        btn.classList.remove("sold", "reserved");
        btn.classList.add("available");
        btn.style.pointerEvents = "auto";
        btn.onclick = () => toggleNumber(num, btn);
      }

      // vendidos
      (data.vendidos || []).forEach(n => {
        const btn = btnByNumber.get(Number(n));
        if (!btn) return;
        btn.classList.remove("available", "selected", "reserved");
        btn.classList.add("sold");
        btn.style.pointerEvents = "none";
        btn.onclick = null;

        // ‚úÖ FIX BUG: no borrar selecci√≥n si ya est√° bloqueado el checkout
        if (!checkoutLocked) {
          selectedNumbers = selectedNumbers.filter(x => Number(x) !== Number(n));
        }
      });

      // reservados
      (data.reservados || []).forEach(n => {
        const btn = btnByNumber.get(Number(n));
        if (!btn) return;
        btn.classList.remove("available", "selected", "sold");
        btn.classList.add("reserved");
        btn.style.pointerEvents = "none";
        btn.onclick = null;

        // ‚úÖ FIX BUG: no borrar selecci√≥n si ya est√° bloqueado el checkout
        if (!checkoutLocked) {
          selectedNumbers = selectedNumbers.filter(x => Number(x) !== Number(n));
        }
      });

      // re-pintar selecci√≥n (si queda algo) SOLO si no est√° bloqueado
      if (!checkoutLocked) {
        for (const n of selectedNumbers) {
          const btn = btnByNumber.get(Number(n));
          if (btn && btn.classList.contains("available")) btn.classList.add("selected");
        }
      }

      updateSelectionUI_();
      msg.textContent = "Listo ‚úÖ Elige tus folios disponibles.";
    } catch (e) {
      msg.textContent = "No pude cargar el estado. Revisa /api/gs.";
    } finally {
      isLoadingStatus = false;
      setGridEnabled(true);
    }
  }

  function toggleNumber(num, el) {
    if (checkoutLocked) return; // ‚úÖ FIX BUG: no permitir cambios si ya se cre√≥ el pago
    if (isLoadingStatus) return;
    if (el.classList.contains("sold") || el.classList.contains("reserved")) return;

    const exists = selectedNumbers.includes(num);

    // quitar
    if (exists) {
      selectedNumbers = selectedNumbers.filter(n => n !== num);
      el.classList.remove("selected");
      resetCheckoutUI_();
      updateSelectionUI_();
      return;
    }

    // agregar (con l√≠mite)
    if (selectedNumbers.length >= MAX_SELECT) {
      alert(`‚ö†Ô∏è M√°ximo ${MAX_SELECT} folios por compra. Puedes pagar y luego elegir m√°s.`);
      return;
    }

    selectedNumbers.push(num);
    el.classList.add("selected");

    resetCheckoutUI_();
    document.getElementById("random-lucky-msg").innerText =
      luckyMessages[Math.floor(Math.random() * luckyMessages.length)];

    updateSelectionUI_();
    document.getElementById("checkout-container").scrollIntoView({ behavior: "smooth", block: "center" });
  }

  // ========= CREAR PAGO (single o multi) =========
  async function renderPaymentButton() {
    const name = document.getElementById("user-name").value.trim();
    const phone = document.getElementById("user-phone").value.trim();
    const btnPre = document.getElementById("btn-pre-pago");

    if (!window.MercadoPago) {
      alert("Mercado Pago no carg√≥. Recarga la p√°gina e intenta de nuevo.");
      return;
    }

    if (!selectedNumbers.length) {
      alert("Selecciona al menos un folio.");
      return;
    }

    if (!name || phone.length < 10 || isNaN(phone)) {
      alert("‚ö†Ô∏è WhatsApp v√°lido (solo n√∫meros, 10 d√≠gitos).");
      return;
    }

    // ‚úÖ COMPATIBLE con code.gs: "card" o "offline"
    const pay_method = (payMode === "offline") ? "offline" : "card";

    btnPre.innerText = "Conectando...";
    btnPre.disabled = true;

    // Ordenar selecci√≥n (bonito y consistente)
    const numbersSorted = [...selectedNumbers].sort((a,b)=>a-b);

    try {
      const payload = {
        action: "create_preference",
        name: name,
        phone: phone,
        pay_method: pay_method
      };

      // ‚úÖ backward-compatible:
      if (numbersSorted.length === 1) payload.number = numbersSorted[0];
      else payload.numbers = numbersSorted;

      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const preference = await response.json();

      if (preference.ok && preference.id) {
        btnPre.style.display = "none";

        // ‚úÖ FIX BUG: bloquear checkout para que cargarStatus NO borre selecci√≥n / NO oculte wallet
        checkoutLocked = true;
        lockedNumbers = numbersSorted;

        // bloquear inputs y selector m√©todo mientras paga
        document.getElementById("user-name").disabled = true;
        document.getElementById("user-phone").disabled = true;
        pillInstant.style.pointerEvents = "none";
        pillOffline.style.pointerEvents = "none";
        btnClearSel.disabled = true;

        // Guardamos preference_id para mostrar comprobante al volver
        localStorage.setItem("last_preference_id", preference.id);

        // Para fallback visual si algo no carga (guardamos lista)
        localStorage.setItem("last_numbers", JSON.stringify(numbersSorted));
        localStorage.setItem("last_total", String(numbersSorted.length * PRICE));

        const bricksBuilder = mp.bricks();
        await bricksBuilder.create("wallet", "wallet_container", {
          initialization: { preferenceId: preference.id, redirectMode: "modal" }
        });

        // refrescar status sin romper el wallet
        await cargarStatus();
      } else {
        throw new Error(preference.error || "Sin preference id");
      }
    } catch (error) {
      alert("Error: " + error.message);

      // ‚úÖ si falla, desbloquear
      checkoutLocked = false;
      lockedNumbers = [];
      document.getElementById("user-name").disabled = false;
      document.getElementById("user-phone").disabled = false;
      pillInstant.style.pointerEvents = "auto";
      pillOffline.style.pointerEvents = "auto";
      btnClearSel.disabled = false;

      btnPre.innerText = "Confirmar y Pagar";
      btnPre.disabled = false;
      await cargarStatus();
    }
  }

  document.getElementById("btn-pre-pago").addEventListener("click", renderPaymentButton);

  // ========= OVERLAY / COMPROBANTE =========
  const overlay = document.getElementById("confirmOverlay");
  const overlayClose = document.getElementById("overlayClose");
  const ovSubtitle = document.getElementById("ovSubtitle");
  const ovBadge = document.getElementById("ovBadge");
  const ovNumber = document.getElementById("ovNumber");
  const ovNumbersRow = document.getElementById("ovNumbersRow");
  const ovNumbers = document.getElementById("ovNumbers");

  const tName = document.getElementById("tName");
  const tPhone = document.getElementById("tPhone");
  const tStatus = document.getElementById("tStatus");
  const tPayId = document.getElementById("tPayId");
  const tDate = document.getElementById("tDate");
  const tTotal = document.getElementById("tTotal");

  const btnPrint = document.getElementById("btnPrint");
  const btnRefreshStatus = document.getElementById("btnRefreshStatus");

  // ===== SHARE (LINK + QR) =====
  const ticketLinkInput = document.getElementById("ticketLinkInput");
  const btnCopyLink = document.getElementById("btnCopyLink");
  const ticketQR = document.getElementById("ticketQR");
  const shareStatus = document.getElementById("shareStatus");

  function buildPermanentTicketLink(preferenceId) {
    const base = window.location.origin;
    return base + "/?ticket=" + encodeURIComponent(preferenceId);
  }

  function setShareUI(preferenceId) {
    if (!preferenceId) {
      shareStatus.textContent = "SIN LINK";
      ticketLinkInput.value = "‚Äî";
      ticketQR.innerHTML = "";
      return;
    }

    const link = buildPermanentTicketLink(preferenceId);
    shareStatus.textContent = "LISTO";
    ticketLinkInput.value = link;

    ticketQR.innerHTML = "";
    if (window.QRCode) {
      new QRCode(ticketQR, { text: link, width: 150, height: 150 });
    } else {
      ticketQR.innerHTML = `<div class="text-xs text-slate-300">No carg√≥ QRCode</div>`;
    }
  }

  if (btnCopyLink) {
    btnCopyLink.addEventListener("click", async () => {
      try {
        const text = ticketLinkInput.value;
        if (!text || text === "‚Äî") return;
        await navigator.clipboard.writeText(text);
        btnCopyLink.textContent = "¬°Copiado!";
        setTimeout(() => (btnCopyLink.textContent = "Copiar"), 1200);
      } catch {
        alert("No pude copiar. Copia manualmente el link.");
      }
    });
  }

  function showOverlay() {
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  }

  function hideOverlay() {
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");

    const cleanUrl = window.location.origin + window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);
  }

  overlayClose.addEventListener("click", hideOverlay);
  btnPrint.addEventListener("click", () => window.print());

  function setBadge(type, text) {
    let html = "";
    if (type === "loading") html = `<span class="spinner"></span> ${text}`;
    if (type === "ok") html = `‚úÖ ${text}`;
    if (type === "pending") html = `üïí ${text}`;
    if (type === "fail") html = `‚ùå ${text}`;
    ovBadge.innerHTML = html;
  }

  function formatDate(val){
    try {
      if (!val) return "‚Äî";
      const d = (typeof val === "string") ? new Date(val) : new Date(val);
      if (isNaN(d.getTime())) return String(val);
      return d.toLocaleString("es-MX");
    } catch {
      return String(val || "‚Äî");
    }
  }

  async function loadTicketByPreference(preferenceId) {
    const r = await fetch(API_URL + `?action=get_ticket&preference_id=${encodeURIComponent(preferenceId)}`, { method: "GET" });
    return await r.json();
  }

  async function verifyPayment(paymentId) {
    const r = await fetch(API_URL + `?action=verify_payment&payment_id=${encodeURIComponent(paymentId)}`, { method: "GET" });
    return await r.json();
  }

  async function releaseReservationByPreference(preferenceId) {
    if (!preferenceId) return;
    try {
      await fetch(API_URL + `?action=release_reservation&preference_id=${encodeURIComponent(preferenceId)}`, {
        method: "GET"
      });
    } catch (e) {}
  }

  function getFallbackNumbers_(){
    try{
      const raw = localStorage.getItem("last_numbers");
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr.map(Number).filter(n => !isNaN(n));
    }catch{
      return [];
    }
  }

  function paintTicketFromSheet(ticket) {
    const nums = Array.isArray(ticket.numbers) ? ticket.numbers.map(Number).filter(n=>!isNaN(n)) : [];
    const fallbackNums = getFallbackNumbers_();

    const finalNums = nums.length ? nums : (ticket.numero ? [Number(ticket.numero)] : fallbackNums);
    const qty = ticket.qty != null ? Number(ticket.qty) : finalNums.length;
    const total = ticket.total != null ? Number(ticket.total) : (qty * PRICE);

    if (qty && qty > 1) {
      ovNumber.textContent = String(qty);
      ovNumbersRow.classList.remove("hidden");
      ovNumbers.textContent = finalNums.length ? formatNumberList_(finalNums) : "‚Äî";
    } else {
      ovNumber.textContent = finalNums.length ? String(finalNums[0]) : "--";
      ovNumbersRow.classList.add("hidden");
      ovNumbers.textContent = "‚Äî";
    }

    tName.textContent = ticket.nombre || "‚Äî";
    tPhone.textContent = ticket.whatsapp || "‚Äî";

    const st = String(ticket.estado || ticket.status || "‚Äî").toUpperCase();
    if (st === "VENDIDO") tStatus.textContent = "‚úÖ CONFIRMADO";
    else if (st === "RESERVADO") tStatus.textContent = "üïí EN PROCESO";
    else tStatus.textContent = ticket.estado || "‚Äî";

    tPayId.textContent = ticket.id_pago || "‚Äî";
    tDate.textContent = formatDate(ticket.fecha);
    tTotal.textContent = `$${total || (finalNums.length * PRICE)} MXN`;
  }

  function paintBasicFallback() {
    const fallbackNums = getFallbackNumbers_();
    if (fallbackNums.length > 1) {
      ovNumber.textContent = String(fallbackNums.length);
      ovNumbersRow.classList.remove("hidden");
      ovNumbers.textContent = formatNumberList_(fallbackNums);
      tTotal.textContent = `$${fallbackNums.length * PRICE} MXN`;
    } else {
      ovNumber.textContent = fallbackNums.length ? String(fallbackNums[0]) : "--";
      ovNumbersRow.classList.add("hidden");
      ovNumbers.textContent = "‚Äî";
      tTotal.textContent = "‚Äî";
    }

    tName.textContent = "‚Äî";
    tPhone.textContent = "‚Äî";
    tStatus.textContent = "‚Äî";
    tPayId.textContent = "‚Äî";
    tDate.textContent = "‚Äî";
  }

  async function refreshOverlayStatus() {
    showOverlay();
    setBadge("loading", "VERIFICANDO");
    ovSubtitle.textContent = "Cargando tu comprobante‚Ä¶";

    const qs = new URLSearchParams(window.location.search);

    const pago = qs.get("pago");
    const payment_id = qs.get("payment_id") || qs.get("collection_id") || "";
    const status = qs.get("status") || "";

    const ticket_pref = qs.get("ticket") || "";
    const preference_id_from_qs = qs.get("preference_id") || "";

    const prefFromStorage = localStorage.getItem("last_preference_id") || "";
    const pref = ticket_pref || preference_id_from_qs || prefFromStorage;

    if (pref) {
      try {
        const ticket = await loadTicketByPreference(pref);
        if (ticket.ok) paintTicketFromSheet(ticket);
        else paintBasicFallback();
      } catch {
        paintBasicFallback();
      }
    } else {
      paintBasicFallback();
    }

    setShareUI(pref);

    if (payment_id) {
      ovSubtitle.textContent = "Verificando tu pago con Mercado Pago‚Ä¶";
      try {
        const v = await verifyPayment(payment_id);
        if (v.ok) {
          if (v.status === "approved") {
            setBadge("ok", "PAGO APROBADO");
            ovSubtitle.textContent = "¬°Listo! Tu compra ya est√° confirmada.";
            tStatus.textContent = "‚úÖ CONFIRMADO";
            tPayId.textContent = v.id || payment_id;
          } else if (v.status === "pending" || v.status === "in_process") {
            setBadge("pending", "PAGO PENDIENTE");
            ovSubtitle.textContent = "Tu pago est√° en proceso. Puedes volver despu√©s a actualizar.";
            tStatus.textContent = "üïí EN PROCESO";
            tPayId.textContent = v.id || payment_id;
          } else {
            setBadge("fail", "PAGO NO APROBADO");
            ovSubtitle.textContent = "No se aprob√≥ el pago. Puedes intentar de nuevo.";
            tStatus.textContent = `‚ùå NO APROBADO (${v.status})`;
            tPayId.textContent = v.id || payment_id;

            await releaseReservationByPreference(pref);
            localStorage.removeItem("last_preference_id");
            localStorage.removeItem("last_numbers");
            localStorage.removeItem("last_total");
            await cargarStatus();
          }
        } else {
          if (pago === "success" || status === "approved") {
            setBadge("ok", "PAGO APROBADO");
            ovSubtitle.textContent = "Pago aprobado. Si tarda en reflejarse, actualiza en unos segundos.";
          } else if (pago === "pending" || status === "pending") {
            setBadge("pending", "PAGO PENDIENTE");
            ovSubtitle.textContent = "Tu pago est√° en proceso.";
          } else if (pago === "failure") {
            setBadge("fail", "PAGO FALLIDO");
            ovSubtitle.textContent = "No se complet√≥ el pago.";
          } else {
            setBadge("pending", "PROCESANDO");
            ovSubtitle.textContent = "No pude verificar autom√°ticamente. Intenta actualizar estado.";
          }
        }
      } catch {
        setBadge("pending", "PROCESANDO");
        ovSubtitle.textContent = "No pude verificar autom√°ticamente. Intenta actualizar estado.";
      }
      return;
    }

    if (ticket_pref) {
      const shownStatus = (tStatus.textContent || "").toUpperCase();
      if (shownStatus.includes("CONFIRMADO")) {
        setBadge("ok", "CONFIRMADO");
        ovSubtitle.textContent = "‚úÖ Pago confirmado. Este es tu comprobante validado.";
      } else {
        setBadge("pending", "EN PROCESO");
        ovSubtitle.textContent = "üïí Si pagaste por transferencia/OXXO, puede tardar. Usa ‚ÄúActualizar estado‚Äù.";
      }
      return;
    }

    if (pago === "success" || status === "approved") {
      setBadge("ok", "PAGO APROBADO");
      ovSubtitle.textContent = "¬°Listo! Si no ves el comprobante a√∫n, actualiza en unos segundos.";
      return;
    }
    if (pago === "pending" || status === "pending") {
      setBadge("pending", "PAGO PENDIENTE");
      ovSubtitle.textContent = "Tu pago est√° en proceso. Puedes volver despu√©s a actualizar.";
      return;
    }
    if (pago === "failure") {
      setBadge("fail", "PAGO FALLIDO");
      ovSubtitle.textContent = "No se complet√≥ el pago. Intenta de nuevo.";
      return;
    }

    hideOverlay();
  }

  btnRefreshStatus.addEventListener("click", async () => {
    await refreshOverlayStatus();
    await cargarStatus();
  });

  // ========= Ventana 72H (COUNTDOWN) =========
  const PROMO_END_ISO = "2025-12-29T18:00:00-07:00";
  const PROMO_TOTAL_MS = 72 * 60 * 60 * 1000;
  const PROMO_BLOCK_PURCHASES_WHEN_ENDS = false;

  const promoTime = document.getElementById("promoTime");
  const promoState = document.getElementById("promoState");
  const promoEndsAt = document.getElementById("promoEndsAt");
  const promoBar = document.getElementById("promoBar");

  function formatEndsAt_(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("es-MX", { dateStyle: "full", timeStyle: "short" });
    }catch{
      return iso;
    }
  }

  function msToHHMMSS_(ms){
    const s = Math.max(0, Math.floor(ms / 1000));
    const hh = String(Math.floor(s / 3600)).padStart(2,"0");
    const mm = String(Math.floor((s % 3600) / 60)).padStart(2,"0");
    const ss = String(s % 60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }

  function setPurchasesEnabled_(enabled){
    const btnPre = document.getElementById("btn-pre-pago");
    if (btnPre) {
      btnPre.disabled = !enabled;
      if (!enabled) {
        btnPre.innerText = "Ventana finalizada";
        btnPre.style.opacity = "0.65";
        btnPre.style.cursor = "not-allowed";
      }
    }

    const nameInput = document.getElementById("user-name");
    const phoneInput = document.getElementById("user-phone");
    if (nameInput) nameInput.disabled = !enabled;
    if (phoneInput) phoneInput.disabled = !enabled;
  }

  function initPromo72h_(){
    promoEndsAt.textContent = `‚è≥ Termina: ${formatEndsAt_(PROMO_END_ISO)} (Hermosillo)`;

    const end = new Date(PROMO_END_ISO).getTime();
    const start = end - PROMO_TOTAL_MS;

    function tick(){
      const now = Date.now();
      const left = end - now;

      if (left <= 0){
        promoTime.textContent = "00:00:00";
        promoState.textContent = "FINALIZADO";
        promoState.classList.remove("text-blue-400");
        promoState.classList.add("text-red-400");
        promoBar.style.width = "0%";

        if (PROMO_BLOCK_PURCHASES_WHEN_ENDS) {
          setPurchasesEnabled_(false);
        }
        return;
      }

      promoState.textContent = "ACTIVO";
      promoState.classList.remove("text-red-400");
      promoState.classList.add("text-blue-400");
      promoTime.textContent = msToHHMMSS_(left);

      const progress = Math.min(1, Math.max(0, (end - now) / (end - start)));
      promoBar.style.width = `${Math.round(progress * 100)}%`;

      if (PROMO_BLOCK_PURCHASES_WHEN_ENDS) {
        setPurchasesEnabled_(true);
      }
    }

    tick();
    setInterval(tick, 1000);
  }

  // ========= INIT =========
  buildGrid();
  initPromo72h_();
  setGridEnabled(false);
  cargarStatus();

  setInterval(cargarStatus, 20000);

  (async function(){
    const qs = new URLSearchParams(window.location.search);
    if (
      qs.get("ticket") ||
      qs.get("pago") ||
      qs.get("payment_id") ||
      qs.get("collection_id") ||
      qs.get("status") ||
      qs.get("preference_id")
    ) {
      await refreshOverlayStatus();
    }
  })();

  (function initFAQ(){
    const items = document.querySelectorAll(".faq-item");
    items.forEach(item => {
      const btn = item.querySelector(".faq-btn");
      const body = item.querySelector(".faq-body");
      const ico = item.querySelector(".faq-ico");
      if(!btn || !body) return;

      btn.addEventListener("click", () => {
        const open = !body.classList.contains("hidden");

        items.forEach(it => {
          const b = it.querySelector(".faq-body");
          const i = it.querySelector(".faq-ico");
          if (b && b !== body) b.classList.add("hidden");
          if (i && i !== ico) i.textContent = "+";
        });

        if (open) {
          body.classList.add("hidden");
          if (ico) ico.textContent = "+";
        } else {
          body.classList.remove("hidden");
          if (ico) ico.textContent = "‚Äì";
        }
      });
    });
  })();
</script>
</body>
</html>
