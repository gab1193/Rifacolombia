<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rifa Colombia 2026 üá®üá¥</title>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    html, body { background-color: #0f172a; margin: 0; overscroll-behavior: none; }
    body { font-family: 'Poppins', sans-serif; background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); min-height: 100vh; }

    .colombia-title {
      background: linear-gradient(to right, #fcd116 20%, #003893 40%, #ce1126 60%, #fcd116 80%);
      background-size: 200% auto;
      color: #fff;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine-colombia 4s linear infinite;
    }
    @keyframes shine-colombia { to { background-position: 200% center; } }

    .chrome-text {
      background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% auto;
      animation: shine 3s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    .number-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }

    .number-btn{
      aspect-ratio: 1; display:flex; align-items:center; justify-content:center;
      border-radius:12px; transition:all .2s cubic-bezier(.4,0,.2,1);
      font-weight:600; cursor:pointer; border:1px solid rgba(255,255,255,.1);
      background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(4px);
      user-select:none;
      position: relative;
    }
    .available:hover { transform: translateY(-3px) scale(1.1); background: #3b82f6; color: white !important; border-color: #60a5fa; }
    .selected { background: #ffffff !important; color: #0f172a !important; box-shadow: 0 0 25px rgba(255, 255, 255, 0.5); transform: scale(1.1); border-color: white; }

    .sold {
      background: rgba(2, 6, 23, 0.7) !important;
      color: rgba(148,163,184,0.7) !important;
      border-color: rgba(148,163,184,0.15) !important;
      cursor:not-allowed !important;
    }
    .sold::after{
      content:"VENDIDO";
      position:absolute;
      font-size:10px;
      font-weight:800;
      letter-spacing:.12em;
      opacity:.75;
      bottom:6px;
    }

    .reserved {
      background: rgba(30, 41, 59, 0.9) !important;
      color: rgba(251,191,36,0.9) !important;
      border-color: rgba(251,191,36,0.25) !important;
      cursor:not-allowed !important;
    }
    .reserved::after{
      content:"RESERV";
      position:absolute;
      font-size:10px;
      font-weight:800;
      letter-spacing:.12em;
      opacity:.8;
      bottom:6px;
    }

    .glass-card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }

    .progress-fill {
      background: linear-gradient(to right, #fbbf24 33%, #3b82f6 33%, #3b82f6 66%, #ef4444 66%);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      transition: width 1.2s cubic-bezier(0.65, 0, 0.35, 1);
    }
    .payment-icon { filter: grayscale(1) opacity(0.7); transition: 0.3s; }
    .payment-icon:hover { filter: grayscale(0) opacity(1); }

    .pay-pill {
      border: 1px solid rgba(148,163,184,.2);
      background: rgba(2,6,23,.35);
      padding: 12px 14px;
      border-radius: 16px;
      cursor: pointer;
      user-select: none;
      transition: .2s;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .pay-pill:hover { transform: translateY(-1px); border-color: rgba(59,130,246,.45); }
    .pay-pill.active {
      border-color: rgba(59,130,246,.7);
      background: rgba(59,130,246,.15);
      box-shadow: 0 0 0 2px rgba(59,130,246,.15) inset;
    }

    /* ===== Overlay Confirmaci√≥n ===== */
    .overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(2,6,23,.75);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .overlay.show { display: flex; }
    .ticket-card{
      background: rgba(30,41,59,.65);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 28px;
      box-shadow: 0 10px 40px rgba(0,0,0,.4);
      width: 100%;
      max-width: 520px;
      overflow: hidden;
    }
    .ticket-head{
      padding: 18px 18px 14px 18px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(135deg, rgba(59,130,246,.18), rgba(251,191,36,.12), rgba(239,68,68,.10));
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(2,6,23,.35);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .ticket-body{ padding: 18px; }
    .kv { display:flex; justify-content:space-between; gap:12px; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,.08); }
    .kv:last-child{ border-bottom: none; }
    .kv .k{ color: rgba(148,163,184,1); font-size: 12px; text-transform: uppercase; letter-spacing:.16em; font-weight: 800; }
    .kv .v{ color: white; font-weight: 700; }
    .big-number{
      font-size: 60px;
      font-weight: 900;
      letter-spacing: -0.04em;
      line-height: 1;
      color: white;
      text-shadow: 0 0 20px rgba(59,130,246,.2);
    }
    .btnx{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.12em;
      transition:.2s;
      width: 100%;
    }
    .btn-primary{ background:#3b82f6; color:white; }
    .btn-primary:hover{ filter: brightness(1.08); transform: translateY(-1px); }
    .btn-ghost{
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.25);
      color: rgba(226,232,240,1);
    }
    .btn-ghost:hover{ border-color: rgba(59,130,246,.5); transform: translateY(-1px); }
    .spinner{
      width: 18px; height: 18px; border-radius: 50%;
      border: 3px solid rgba(255,255,255,.2);
      border-top-color: white;
      animation: spin 1s linear infinite;
      display:inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* impresi√≥n del ticket */
    @media print {
      body { background: white !important; }
      .overlay { position: static; display: block !important; background: transparent; backdrop-filter:none; }
      #overlayClose { display:none !important; }
      #ticketActions { display:none !important; }
      .ticket-card { box-shadow:none; border:1px solid #ddd; background: white; }
      .ticket-body, .ticket-head { color: #111827 !important; background: white !important; }
      .kv .k { color: #374151 !important; }
      .kv .v { color: #111827 !important; }
      .big-number { color: #111827 !important; text-shadow:none; }
    }
  </style>
</head>

<body class="text-slate-200 p-4">
  <div class="max-w-2xl mx-auto text-center mt-10">
    <h1 class="text-5xl font-extrabold mb-4 tracking-tight colombia-title">Rifa Colombia 2026</h1>

    <div class="mb-6">
      <p class="text-lg text-slate-400 uppercase tracking-widest font-semibold">Gran Premio de</p>
      <h2 class="chrome-text text-6xl md:text-7xl font-black my-2">$10,000 MXN</h2>
    </div>

    <div class="flex justify-center items-center gap-4 mb-10 bg-slate-800/30 py-3 px-6 rounded-full w-fit mx-auto border border-slate-700/50">
      <span class="text-[10px] uppercase font-bold text-slate-500 tracking-tighter">Pagos seguros v√≠a:</span>
      <img src="https://img.icons8.com/color/48/visa.png" class="h-5 payment-icon" alt="Visa"/>
      <img src="https://img.icons8.com/color/48/mastercard.png" class="h-5 payment-icon" alt="Mastercard"/>
      <img src="https://img.icons8.com/color/48/amex.png" class="h-5 payment-icon" alt="Amex"/>
      <span class="text-[10px] font-bold text-blue-400">Mercado Pago</span>
    </div>

    <div class="glass-card p-6 rounded-3xl mb-10 shadow-xl text-center">
      <p class="text-slate-300 leading-relaxed text-lg">
        ¬°Hola! Somos una <span class="text-yellow-500 font-bold">generaci√≥n de estudiantes de actuaci√≥n</span> de Hermosillo.
        Este 2026 viajaremos a representar el talento sonorense en <span class="text-blue-400 font-bold">Colombia</span>. üé≠ <br>
        <span class="text-white">Con tu apoyo, nos ayudas a llevar nuestro arte m√°s all√° de las fronteras.</span>
      </p>
    </div>

    <div class="glass-card p-6 rounded-3xl mb-8 shadow-xl border border-blue-500/20">
      <div class="flex justify-between items-end mb-3">
        <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Progreso de la Meta</span>
        <span class="text-xl font-black text-white">
          <span id="porcentaje-texto">0%</span>
          <span class="text-slate-500 font-medium text-sm ml-2">(<span id="boletos-vendidos-texto">...</span> / 500)</span>
        </span>
      </div>
      <div class="w-full bg-slate-950/50 rounded-full h-4 p-1 border border-slate-800">
        <div id="barra-progreso" class="progress-fill h-full rounded-full" style="width: 0%"></div>
      </div>
      <div class="mt-4 text-xs text-slate-400 flex flex-wrap justify-center gap-3">
        <span>‚úÖ Disponibles: <b id="disponibles-texto" class="text-white">...</b></span>
        <span>üü® Reservados: <b id="reservados-texto" class="text-yellow-400">...</b></span>
        <span>‚¨õ Vendidos: <b id="vendidos-texto" class="text-slate-200">...</b></span>
      </div>
    </div>

    <div class="glass-card p-8 rounded-[2rem] mb-8 shadow-2xl">
      <h2 class="text-2xl font-bold mb-1 text-white">1. Selecciona tu n√∫mero de la suerte</h2>
      <p class="text-green-400 font-medium mb-6">Solo $100 MXN por oportunidad</p>
      <div id="grid" class="number-grid max-h-[400px] overflow-y-auto p-4 rounded-2xl bg-slate-900/50"></div>
      <p id="status-msg" class="text-xs text-slate-400 mt-4"></p>
    </div>

    <div id="checkout-container" class="hidden glass-card p-8 rounded-[2rem] border-2 border-blue-500/50 mb-12 shadow-[0_0_40px_rgba(59,130,246,0.15)] transition-all duration-500">
      <h3 class="text-xl font-bold mb-6 text-white text-center">
        ‚ú® <span id="random-lucky-msg">...</span> Reservando el:
        <span id="selected-number-display" class="text-blue-400 text-3xl ml-2">--</span>
      </h3>

      <div class="space-y-4 mb-8 text-left">
        <div>
          <label class="block text-xs text-slate-400 mb-2 ml-1 font-bold uppercase tracking-widest">Nombre del Participante</label>
          <input type="text" id="user-name" placeholder="Tu nombre completo" class="w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 text-white focus:border-blue-500 outline-none transition-all">
        </div>
        <div>
          <label class="block text-xs text-slate-400 mb-2 ml-1 font-bold uppercase tracking-widest">WhatsApp (Solo n√∫meros)</label>
          <input type="tel" id="user-phone" placeholder="6621234567" class="w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 text-white focus:border-blue-500 outline-none transition-all">
        </div>
      </div>

      <!-- selector m√©todo -->
      <div class="text-left mb-6">
        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2 ml-1">M√©todo de pago</p>

        <div class="grid grid-cols-1 gap-3">
          <div id="pill-instant" class="pay-pill active" role="button" tabindex="0">
            <div>
              <div class="text-white font-bold">Pago inmediato</div>
              <div class="text-xs text-slate-400">Tarjeta / saldo Mercado Pago (confirmaci√≥n al instante)</div>
            </div>
            <div class="text-xs font-black text-blue-400">RESERVA 10 MIN</div>
          </div>

          <div id="pill-offline" class="pay-pill" role="button" tabindex="0">
            <div>
              <div class="text-white font-bold">Transferencia / OXXO</div>
              <div class="text-xs text-slate-400">Puede tardar en confirmarse (Mercado Pago lo valida)</div>
            </div>
            <div class="text-xs font-black text-yellow-400">RESERVA 24 H</div>
          </div>
        </div>

        <p id="reserve-note" class="text-[11px] text-slate-400 mt-3">
          ‚è≥ Tu n√∫mero queda reservado <b class="text-white">10 minutos</b> mientras realizas el pago inmediato.
        </p>
      </div>

      <button id="btn-pre-pago" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition-all shadow-xl shadow-blue-900/30 uppercase tracking-wider">
        Confirmar y Pagar
      </button>

      <div id="wallet_container" class="mt-4"></div>

      <p class="text-[11px] text-slate-500 mt-6 px-4 italic leading-relaxed text-center">
        üõ°Ô∏è Tus datos est√°n seguros. Se usar√°n exclusivamente para contactarte en caso de que tu n√∫mero resulte premiado.
      </p>
    </div>

    <div class="mt-8 pb-24">
      <p class="text-slate-500 font-medium mb-6 uppercase tracking-widest text-xs text-center">¬øDudas?</p>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="https://wa.me/6311824470" class="bg-green-600/10 text-green-400 border border-green-600/20 px-8 py-3 rounded-2xl font-bold hover:bg-green-600 hover:text-white transition-all">WhatsApp</a>
        <a href="https://instagram.com/TU_USUARIO" class="bg-pink-600/10 text-pink-400 border border-pink-600/20 px-8 py-3 rounded-2xl font-bold hover:bg-pink-600 hover:text-white transition-all">Instagram</a>
      </div>
    </div>
  </div>

  <!-- ===== Overlay Confirmaci√≥n + Boleto ===== -->
  <div id="confirmOverlay" class="overlay" aria-hidden="true">
    <div class="ticket-card">
      <div class="ticket-head">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-white font-black text-xl">Tu compra</div>
            <div id="ovSubtitle" class="text-slate-200/80 text-sm">Verificando el pago‚Ä¶</div>
          </div>
          <button id="overlayClose" class="btnx btn-ghost" style="width:auto; padding:10px 12px;">Cerrar</button>
        </div>
        <div class="mt-4 flex items-center justify-between gap-3">
          <span id="ovBadge" class="badge"><span class="spinner"></span> PROCESANDO</span>
          <div class="text-right">
            <div class="text-slate-200/70 text-xs uppercase tracking-[.2em] font-black">N√∫mero</div>
            <div id="ovNumber" class="big-number">--</div>
          </div>
        </div>
      </div>

      <div class="ticket-body">
        <div id="ticketKVs" class="space-y-0">
          <div class="kv"><div class="k">Participante</div><div id="tName" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">WhatsApp</div><div id="tPhone" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">Estado</div><div id="tStatus" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">Pago ID</div><div id="tPayId" class="v">‚Äî</div></div>
          <div class="kv"><div class="k">Fecha</div><div id="tDate" class="v">‚Äî</div></div>
        </div>

        <div id="ticketActions" class="mt-6 space-y-3">
          <button id="btnPrint" class="btnx btn-primary">Guardar / Imprimir boleto</button>
          <button id="btnRefreshStatus" class="btnx btn-ghost">Actualizar estado</button>
        </div>

        <p class="text-[11px] text-slate-400 mt-5 leading-relaxed">
          Tip: Si pagaste por <b class="text-white">transferencia/OXXO</b>, puede tardar. Tu n√∫mero queda reservado y cuando MP lo confirme, se pondr√° <b class="text-white">VENDIDO</b>.
        </p>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const API_URL = "/api/gs";

  // ‚úÖ Public Key (frontend)
  const MP_PUBLIC_KEY = "APP_USR-5cf8db98-d91a-44c4-bb21-b2206fd823a4";
  const mp = new MercadoPago(MP_PUBLIC_KEY, { locale: "es-MX" });

  // ========= STATE =========
  const grid = document.getElementById("grid");
  let currentNumber = null;

  // modo UI
  let payMode = "instant"; // instant/offline

  const luckyMessages = [
    "¬°Excelente elecci√≥n!",
    "¬°Buena vibra!",
    "¬°El ganador!",
    "¬°A por todas!",
    "¬°Tu n√∫mero de la suerte!",
    "¬°Siento la suerte!",
    "¬°Hermosillo presente!"
  ];

  const btnByNumber = new Map();

  // ========= UI: selector m√©todo =========
  const pillInstant = document.getElementById("pill-instant");
  const pillOffline = document.getElementById("pill-offline");
  const reserveNote = document.getElementById("reserve-note");

  function resetCheckoutUI_() {
    document.getElementById("wallet_container").innerHTML = "";
    const btnPre = document.getElementById("btn-pre-pago");
    btnPre.style.display = "block";
    btnPre.disabled = false;
    btnPre.innerText = "Confirmar y Pagar";
  }

  function setPayMode(mode) {
    payMode = mode;
    resetCheckoutUI_();

    if (mode === "offline") {
      pillOffline.classList.add("active");
      pillInstant.classList.remove("active");
      reserveNote.innerHTML = `‚è≥ Tu n√∫mero queda reservado <b class="text-white">24 horas</b> para que completes transferencia / OXXO.`;
    } else {
      pillInstant.classList.add("active");
      pillOffline.classList.remove("active");
      reserveNote.innerHTML = `‚è≥ Tu n√∫mero queda reservado <b class="text-white">10 minutos</b> mientras realizas el pago inmediato.`;
    }
  }

  pillInstant.addEventListener("click", () => setPayMode("instant"));
  pillOffline.addEventListener("click", () => setPayMode("offline"));

  // ========= UI: grid =========
  function buildGrid() {
    grid.innerHTML = "";
    btnByNumber.clear();

    for (let i = 1; i <= 500; i++) {
      const btn = document.createElement("div");
      btn.innerText = i;
      btn.className = "number-btn available";

      if (i % 3 === 0) btn.style.color = "#fbbf24";
      else if (i % 3 === 1) btn.style.color = "#60a5fa";
      else btn.style.color = "#f87171";

      btn.onclick = () => selectNumber(i, btn);

      grid.appendChild(btn);
      btnByNumber.set(i, btn);
    }
  }

  async function cargarStatus() {
    const msg = document.getElementById("status-msg");
    msg.textContent = "Cargando n√∫meros disponibles...";

    try {
      const response = await fetch(API_URL + "?action=get_status", { method: "GET" });
      const data = await response.json();

      const vendidos = data.vendidos_count || 0;
      const porcentaje = Math.floor((vendidos / 500) * 100);
      document.getElementById("barra-progreso").style.width = porcentaje + "%";
      document.getElementById("boletos-vendidos-texto").innerText = vendidos;
      document.getElementById("porcentaje-texto").innerText = porcentaje + "%";

      document.getElementById("disponibles-texto").innerText = data.disponibles_count ?? "...";
      document.getElementById("reservados-texto").innerText = data.reservados_count ?? "...";
      document.getElementById("vendidos-texto").innerText = data.vendidos_count ?? "...";

      // reset grid
      for (const [num, btn] of btnByNumber.entries()) {
        btn.classList.remove("sold", "reserved", "selected");
        btn.classList.add("available");
        btn.style.pointerEvents = "auto";
        btn.onclick = () => selectNumber(num, btn);
      }

      // vendidos
      (data.vendidos || []).forEach(n => {
        const btn = btnByNumber.get(Number(n));
        if (!btn) return;
        btn.classList.remove("available", "selected", "reserved");
        btn.classList.add("sold");
        btn.style.pointerEvents = "none";
        btn.onclick = null;
      });

      // reservados
      (data.reservados || []).forEach(n => {
        const btn = btnByNumber.get(Number(n));
        if (!btn) return;
        btn.classList.remove("available", "selected", "sold");
        btn.classList.add("reserved");
        btn.style.pointerEvents = "none";
        btn.onclick = null;
      });

      msg.textContent = "Listo ‚úÖ Elige un n√∫mero disponible.";
    } catch (e) {
      msg.textContent = "No pude cargar el estado. Revisa /api/gs.";
    }
  }

  function selectNumber(num, el) {
    if (el.classList.contains("sold") || el.classList.contains("reserved")) return;

    document.querySelectorAll(".number-btn").forEach(b => b.classList.remove("selected"));
    el.classList.add("selected");

    currentNumber = num;
    resetCheckoutUI_();

    document.getElementById("selected-number-display").innerText = num;
    document.getElementById("random-lucky-msg").innerText =
      luckyMessages[Math.floor(Math.random() * luckyMessages.length)];

    document.getElementById("checkout-container").classList.remove("hidden");
    document.getElementById("checkout-container").scrollIntoView({ behavior: "smooth", block: "center" });
  }

  // ========= CREAR PAGO =========
  async function renderPaymentButton() {
    const name = document.getElementById("user-name").value.trim();
    const phone = document.getElementById("user-phone").value.trim();
    const btnPre = document.getElementById("btn-pre-pago");

    if (!window.MercadoPago) {
      alert("Mercado Pago no carg√≥. Recarga la p√°gina e intenta de nuevo.");
      return;
    }
    if (!currentNumber) {
      alert("Selecciona un n√∫mero primero.");
      return;
    }
    if (!name || phone.length < 10 || isNaN(phone)) {
      alert("‚ö†Ô∏è WhatsApp v√°lido (solo n√∫meros, 10 d√≠gitos).");
      return;
    }

    const pay_method = (payMode === "offline") ? "offline" : "card";

    btnPre.innerText = "Conectando...";
    btnPre.disabled = true;

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "create_preference",
          number: currentNumber,
          name: name,
          phone: phone,
          pay_method: pay_method
        })
      });

      const preference = await response.json();

      if (preference.ok && preference.id) {
        btnPre.style.display = "none";

        // Guardamos preference_id en localStorage para mostrar boleto al volver
        localStorage.setItem("last_preference_id", preference.id);
        localStorage.setItem("last_number", String(currentNumber));

        const bricksBuilder = mp.bricks();
        await bricksBuilder.create("wallet", "wallet_container", {
          initialization: { preferenceId: preference.id, redirectMode: "modal" }
        });

        await cargarStatus();
      } else {
        throw new Error(preference.error || "Sin preference id");
      }
    } catch (error) {
      alert("Error: " + error.message);
      btnPre.innerText = "Confirmar y Pagar";
      btnPre.disabled = false;
      await cargarStatus();
    }
  }

  document.getElementById("btn-pre-pago").addEventListener("click", renderPaymentButton);

  // ========= OVERLAY / BOLETO =========
  const overlay = document.getElementById("confirmOverlay");
  const overlayClose = document.getElementById("overlayClose");
  const ovSubtitle = document.getElementById("ovSubtitle");
  const ovBadge = document.getElementById("ovBadge");
  const ovNumber = document.getElementById("ovNumber");

  const tName = document.getElementById("tName");
  const tPhone = document.getElementById("tPhone");
  const tStatus = document.getElementById("tStatus");
  const tPayId = document.getElementById("tPayId");
  const tDate = document.getElementById("tDate");

  const btnPrint = document.getElementById("btnPrint");
  const btnRefreshStatus = document.getElementById("btnRefreshStatus");

  function showOverlay() {
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden", "false");
  }
  function hideOverlay() {
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden", "true");
  }
  overlayClose.addEventListener("click", hideOverlay);

  btnPrint.addEventListener("click", () => window.print());

  function setBadge(type, text) {
    // type: ok | pending | fail | loading
    let html = "";
    if (type === "loading") html = `<span class="spinner"></span> ${text}`;
    if (type === "ok") html = `‚úÖ ${text}`;
    if (type === "pending") html = `üïí ${text}`;
    if (type === "fail") html = `‚ùå ${text}`;
    ovBadge.innerHTML = html;
  }

  function formatDate(val){
    try {
      if (!val) return "‚Äî";
      const d = (typeof val === "string") ? new Date(val) : new Date(val);
      if (isNaN(d.getTime())) return String(val);
      return d.toLocaleString("es-MX");
    } catch {
      return String(val || "‚Äî");
    }
  }

  async function loadTicketByPreference(preferenceId) {
    const r = await fetch(API_URL + `?action=get_ticket&preference_id=${encodeURIComponent(preferenceId)}`, { method: "GET" });
    return await r.json();
  }

  async function verifyPayment(paymentId) {
    const r = await fetch(API_URL + `?action=verify_payment&payment_id=${encodeURIComponent(paymentId)}`, { method: "GET" });
    return await r.json();
  }

  function paintTicketFromSheet(ticket) {
    ovNumber.textContent = ticket.numero ? String(ticket.numero) : (localStorage.getItem("last_number") || "--");
    tName.textContent = ticket.nombre || "‚Äî";
    tPhone.textContent = ticket.whatsapp || "‚Äî";
    tStatus.textContent = ticket.estado || "‚Äî";
    tPayId.textContent = ticket.id_pago || "‚Äî";
    tDate.textContent = formatDate(ticket.fecha);
  }

  function paintBasicFallback() {
    ovNumber.textContent = localStorage.getItem("last_number") || "--";
    tName.textContent = "‚Äî";
    tPhone.textContent = "‚Äî";
    tStatus.textContent = "‚Äî";
    tPayId.textContent = "‚Äî";
    tDate.textContent = "‚Äî";
  }

  async function refreshOverlayStatus() {
    showOverlay();
    setBadge("loading", "VERIFICANDO");
    ovSubtitle.textContent = "Verificando tu pago con Mercado Pago‚Ä¶";

    const qs = new URLSearchParams(window.location.search);

    // datos posibles que regresa MP
    const pago = qs.get("pago"); // success/pending/failure
    const payment_id = qs.get("payment_id") || qs.get("collection_id") || "";
    const status = qs.get("status") || "";
    const preference_id_from_qs = qs.get("preference_id") || "";

    const prefFromStorage = localStorage.getItem("last_preference_id") || "";
    const pref = preference_id_from_qs || prefFromStorage;

    // 1) Pintamos ticket desde sheet (si existe preference)
    if (pref) {
      try {
        const ticket = await loadTicketByPreference(pref);
        if (ticket.ok) {
          paintTicketFromSheet(ticket);
        } else {
          paintBasicFallback();
        }
      } catch {
        paintBasicFallback();
      }
    } else {
      paintBasicFallback();
    }

    // 2) Si tenemos payment_id, verificamos status REAL en MP
    if (payment_id) {
      try {
        const v = await verifyPayment(payment_id);
        if (v.ok) {
          // status real
          if (v.status === "approved") {
            setBadge("ok", "PAGO APROBADO");
            ovSubtitle.textContent = "¬°Listo! Tu boleto ya est√° confirmado.";
            tStatus.textContent = "VENDIDO (aprobado)";
            tPayId.textContent = v.id || payment_id;
          } else if (v.status === "pending" || v.status === "in_process") {
            setBadge("pending", "PAGO PENDIENTE");
            ovSubtitle.textContent = "Tu pago est√° en proceso. Puedes volver despu√©s a actualizar.";
            tStatus.textContent = "RESERVADO / PENDIENTE";
            tPayId.textContent = v.id || payment_id;
          } else {
            setBadge("fail", "PAGO NO APROBADO");
            ovSubtitle.textContent = "No se aprob√≥ el pago. Puedes intentar de nuevo.";
            tStatus.textContent = `NO APROBADO (${v.status})`;
            tPayId.textContent = v.id || payment_id;
          }
        } else {
          // no se pudo consultar MP, usamos fallback por query
          if (pago === "success" || status === "approved") {
            setBadge("ok", "PAGO APROBADO");
            ovSubtitle.textContent = "Pago aprobado. Si tu boleto tarda en reflejarse, actualiza en unos segundos.";
          } else if (pago === "pending" || status === "pending") {
            setBadge("pending", "PAGO PENDIENTE");
            ovSubtitle.textContent = "Tu pago est√° en proceso.";
          } else if (pago === "failure") {
            setBadge("fail", "PAGO FALLIDO");
            ovSubtitle.textContent = "No se complet√≥ el pago.";
          } else {
            setBadge("pending", "PROCESANDO");
            ovSubtitle.textContent = "No pude verificar autom√°ticamente. Intenta actualizar estado.";
          }
        }
      } catch {
        setBadge("pending", "PROCESANDO");
        ovSubtitle.textContent = "No pude verificar autom√°ticamente. Intenta actualizar estado.";
      }
    } else {
      // Sin payment_id: usamos el pago=success/pending/failure
      if (pago === "success" || status === "approved") {
        setBadge("ok", "PAGO APROBADO");
        ovSubtitle.textContent = "¬°Listo! Si no ves el boleto a√∫n, actualiza en unos segundos.";
      } else if (pago === "pending" || status === "pending") {
        setBadge("pending", "PAGO PENDIENTE");
        ovSubtitle.textContent = "Tu pago est√° en proceso. Puedes volver despu√©s a actualizar.";
      } else if (pago === "failure") {
        setBadge("fail", "PAGO FALLIDO");
        ovSubtitle.textContent = "No se complet√≥ el pago. Intenta de nuevo.";
      } else {
        // No venimos de MP
        hideOverlay();
        return;
      }
    }
  }

  btnRefreshStatus.addEventListener("click", async () => {
    await refreshOverlayStatus();
    await cargarStatus();
  });

  // ========= INIT =========
  buildGrid();
  cargarStatus();
  setInterval(cargarStatus, 20000);

  // Si venimos de MP, abrimos overlay
  (async function(){
    const qs = new URLSearchParams(window.location.search);
    if (qs.get("pago") || qs.get("payment_id") || qs.get("collection_id") || qs.get("status") || qs.get("preference_id")) {
      await refreshOverlayStatus();
    }
  })();
</script>
</body>
</html>
